(()=>{"use strict";var t={912:(t,i,e)=>{e.d(i,{Z:()=>d});var s=e(537),n=e.n(s),o=e(645),a=e.n(o),r=e(667),h=e.n(r),l=new URL(e(225),e.b),c=a()(n()),_=h()(l);c.push([t.id,"@font-face{font-family:'Nunito';src:url("+_+") format('woff2');font-weight:900;font-style:#000}body{position:fixed;top:0;left:0;display:flex;justify-content:center;width:100%;height:100%;margin:0;padding:0;overflow:hidden;background-color:#0f335a}","",{version:3,sources:["webpack://./src/assets/styles/index.styl"],names:[],mappings:"AAAA,WACE,oBAAY,CACZ,2DAAqC,CACrC,eAAY,CACZ,eAAW,CAEb,KACE,cAAS,CACT,KAAI,CACJ,MAAK,CACL,YAAQ,CACR,sBAAgB,CAChB,UAAM,CACN,WAAO,CACP,QAAO,CACP,SAAQ,CACR,eAAS,CACT,wBAAiB",sourcesContent:["@font-face\r\n  font-family 'Nunito'\r\n  src url('../fonts/Nunito-Black.woff2') format('woff2')\r\n  font-weight 900\r\n  font-style black\r\n\r\nbody\r\n  position fixed\r\n  top 0\r\n  left 0\r\n  display flex\r\n  justify-content center\r\n  width 100%\r\n  height 100%\r\n  margin 0\r\n  padding 0\r\n  overflow hidden\r\n  background-color #0F335A\r\n\t\t\t"],sourceRoot:""}]);const d=c},645:t=>{t.exports=function(t){var i=[];return i.toString=function(){return this.map((function(i){var e="",s=void 0!==i[5];return i[4]&&(e+="@supports (".concat(i[4],") {")),i[2]&&(e+="@media ".concat(i[2]," {")),s&&(e+="@layer".concat(i[5].length>0?" ".concat(i[5]):""," {")),e+=t(i),s&&(e+="}"),i[2]&&(e+="}"),i[4]&&(e+="}"),e})).join("")},i.i=function(t,e,s,n,o){"string"==typeof t&&(t=[[null,t,void 0]]);var a={};if(s)for(var r=0;r<this.length;r++){var h=this[r][0];null!=h&&(a[h]=!0)}for(var l=0;l<t.length;l++){var c=[].concat(t[l]);s&&a[c[0]]||(void 0!==o&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=o),e&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=e):c[2]=e),n&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=n):c[4]="".concat(n)),i.push(c))}},i}},667:t=>{t.exports=function(t,i){return i||(i={}),t?(t=String(t.__esModule?t.default:t),/^['"].*['"]$/.test(t)&&(t=t.slice(1,-1)),i.hash&&(t+=i.hash),/["'() \t\n]|(%20)/.test(t)||i.needQuotes?'"'.concat(t.replace(/"/g,'\\"').replace(/\n/g,"\\n"),'"'):t):t}},537:t=>{t.exports=function(t){var i=t[1],e=t[3];if(!e)return i;if("function"==typeof btoa){var s=btoa(unescape(encodeURIComponent(JSON.stringify(e)))),n="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),o="/*# ".concat(n," */");return[i].concat([o]).join("\n")}return[i].join("\n")}},379:t=>{var i=[];function e(t){for(var e=-1,s=0;s<i.length;s++)if(i[s].identifier===t){e=s;break}return e}function s(t,s){for(var o={},a=[],r=0;r<t.length;r++){var h=t[r],l=s.base?h[0]+s.base:h[0],c=o[l]||0,_="".concat(l," ").concat(c);o[l]=c+1;var d=e(_),u={css:h[1],media:h[2],sourceMap:h[3],supports:h[4],layer:h[5]};if(-1!==d)i[d].references++,i[d].updater(u);else{var g=n(u,s);s.byIndex=r,i.splice(r,0,{identifier:_,updater:g,references:1})}a.push(_)}return a}function n(t,i){var e=i.domAPI(i);return e.update(t),function(i){if(i){if(i.css===t.css&&i.media===t.media&&i.sourceMap===t.sourceMap&&i.supports===t.supports&&i.layer===t.layer)return;e.update(t=i)}else e.remove()}}t.exports=function(t,n){var o=s(t=t||[],n=n||{});return function(t){t=t||[];for(var a=0;a<o.length;a++){var r=e(o[a]);i[r].references--}for(var h=s(t,n),l=0;l<o.length;l++){var c=e(o[l]);0===i[c].references&&(i[c].updater(),i.splice(c,1))}o=h}}},569:t=>{var i={};t.exports=function(t,e){var s=function(t){if(void 0===i[t]){var e=document.querySelector(t);if(window.HTMLIFrameElement&&e instanceof window.HTMLIFrameElement)try{e=e.contentDocument.head}catch(t){e=null}i[t]=e}return i[t]}(t);if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(e)}},216:t=>{t.exports=function(t){var i=document.createElement("style");return t.setAttributes(i,t.attributes),t.insert(i,t.options),i}},565:(t,i,e)=>{t.exports=function(t){var i=e.nc;i&&t.setAttribute("nonce",i)}},37:t=>{var i,e=(i=[],function(t,e){return i[t]=e,i.filter(Boolean).join("\n")});function s(t,i,s,n){var o;if(s)o="";else{o="",n.supports&&(o+="@supports (".concat(n.supports,") {")),n.media&&(o+="@media ".concat(n.media," {"));var a=void 0!==n.layer;a&&(o+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),o+=n.css,a&&(o+="}"),n.media&&(o+="}"),n.supports&&(o+="}")}if(t.styleSheet)t.styleSheet.cssText=e(i,o);else{var r=document.createTextNode(o),h=t.childNodes;h[i]&&t.removeChild(h[i]),h.length?t.insertBefore(r,h[i]):t.appendChild(r)}}var n={singleton:null,singletonCounter:0};t.exports=function(t){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var i=n.singletonCounter++,e=n.singleton||(n.singleton=t.insertStyleElement(t));return{update:function(t){s(e,i,!1,t)},remove:function(t){s(e,i,!0,t)}}}},225:(t,i,e)=>{t.exports=e.p+"fonts/Nunito-Black.woff2"},170:(t,i,e)=>{t.exports=e.p+"images/star-blue-af7903449c2ce244dcae.png"},397:(t,i,e)=>{t.exports=e.p+"images/star-green-f0d2691d1a94d1af287b.png"},933:(t,i,e)=>{t.exports=e.p+"images/star-yellow-4ad40b40a60494284ced.png"}},i={};function e(s){var n=i[s];if(void 0!==n)return n.exports;var o=i[s]={id:s,exports:{}};return t[s](o,o.exports,e),o.exports}e.m=t,e.n=t=>{var i=t&&t.__esModule?()=>t.default:()=>t;return e.d(i,{a:i}),i},e.d=(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),e.o=(t,i)=>Object.prototype.hasOwnProperty.call(t,i),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var i=e.g.document;if(!t&&i&&(i.currentScript&&(t=i.currentScript.src),!t)){var s=i.getElementsByTagName("script");s.length&&(t=s[s.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})(),e.b=document.baseURI||self.location.href,e.nc=void 0,(()=>{var t=e(379),i=e.n(t),s=e(37),n=e.n(s),o=e(569),a=e.n(o),r=e(565),h=e.n(r),l=e(216),c=e.n(l),_=e(912),d={};d.setAttributes=h(),d.insert=a().bind(null,"head"),d.domAPI=n(),d.insertStyleElement=c(),i()(_.Z,d),_.Z&&_.Z.locals&&_.Z.locals;class u{constructor(){this._assets={},this._loaded=0}load(){return new Promise((t=>{u.data.length||t(),u.data.forEach((i=>{const e=i.fileName.split(".").pop();u.imagesTypes.includes(e)&&this._loadImage(i,t)}))}))}_increaseLoaded(t){this._loaded+=1,this._loaded===u.data.length&&t()}_loadImage(t,i){const e=new Image;e.addEventListener("load",(()=>{this._assets[t.fileName]=e,this._increaseLoaded(i)})),e.src=t.file}get(t){return this._assets[t]}static imagesTypes=["png"];static data=[{fileName:"star-yellow.png",file:e(933)},{fileName:"star-blue.png",file:e(170)},{fileName:"star-green.png",file:e(397)}]}class g{static ysdk=null;static player=null;static async initYSDK(){return YaGames.init().then((t=>{g.ysdk=t,t.features.LoadingAPI?.ready(),console.log("Yandex SDK initialized")})).catch((t=>{console.log("Ошибка при инициализации YSDK")}))}static async initPlayer(){return g.ysdk.getPlayer({scopes:!1}).then((t=>{g.player=t,console.log("Player initialized")})).catch((t=>{console.log("Ошибка при инициализации объекта Player")}))}static async savePlayerStats(t){return g.player.setStats(t).then((()=>{console.log("Player data is saved")})).catch((t=>{console.log("Ошибка при сохранении данных игрока")}))}static async getPlayerStats(){return g.player.getStats().then((t=>(console.log("Получены сохраненные данные игрока"),t))).catch((t=>{console.log("Ошибка при получении данных игрока")}))}}class p{constructor(){this._levelsResult={}}async loadPlayerStats(){const t=await g.getPlayerStats();t&&(this._levelsResult=t)}getRating(){return Object.values(this._levelsResult).reduce(((t,i)=>t+i),0)}async setLevelResult(t,i){const e=this._levelsResult[t];(!e||e<i)&&(this._levelsResult[t]=i,await g.savePlayerStats(this._levelsResult))}getLevelResult(t){return this._levelsResult[t]}}class v{static rect(t,i,e,s,n,o,a=1){t.globalAlpha=a,t.fillStyle=o,t.fillRect(i,e,s,n),t.globalAlpha=1}static roundedRect(t,i,e,s,n,o,a,r=1){t.globalAlpha=r,t.fillStyle=a,t.beginPath(),t.moveTo(i,e+o),t.arcTo(i,e+n,i+o,e+n,o),t.arcTo(i+s,e+n,i+s,e+n-o,o),t.arcTo(i+s,e,i+s-o,e,o),t.arcTo(i,e,i,e+o,o),t.fill(),t.globalAlpha=1}static stroke(t,i,e){t.strokeStyle=e,t.lineWidth=i,t.stroke()}static text(t,i,e,s,n,o,a=1){t.globalAlpha=a,t.fillStyle=o,t.font=`${n}px Nunito`,t.fillText(s,i,e),t.globalAlpha=1}static image(t,i,e,s,n,o,a=1){t.globalAlpha=a,t.drawImage(o,i,e,s,n),t.globalAlpha=1}static slicedImage(t,i,e,s,n,o,a,r,h,l,c=1){t.globalAlpha=c,t.drawImage(l,i,e,s,n,o,a,r,h),t.globalAlpha=1}}class m{static blueDeep={id:2,key:"#0F335A"};static blueNight={id:3,key:"#143D6C"};static blue={id:4,key:"#4A5AEC"};static green={id:5,key:"#73AE37"};static sea={id:6,key:"#4BD5F5"};static red={id:7,key:"#D74E23"};static purple={id:8,key:"#E436EE"};static orange={id:9,key:"#FF891C"};static yellow={id:10,key:"#FFC530"};static white={id:11,key:"#FFFFFF"}}class x{static calcTextMetrics(t,i,e){t.font=`${e}px Nunito`;const{width:s,actualBoundingBoxAscent:n,actualBoundingBoxDescent:o}=t.measureText(i);return{textWidth:s,textHeight:n+o}}static calcMultistringTextMetrics(t,i,e,s){return i.map(((n,o)=>{const a=i.slice(0,o),r=a.reduce(((t,i)=>t+i.length*s),0)+a.length*s;return n.map(((i,n)=>{const{textWidth:o}=x.calcTextMetrics(t,i,e);return{string:i,width:o,positionY:r+n*s+e}}))})).flat()}}class y{constructor({ctx:t,position:i,size:e,label:s}){this._ctx=t,this._position=i,this._size=e,this._label=s,this._labelPosition={x:0,y:0},this._setLabelPosition()}render(){v.roundedRect(this._ctx,this._position.x,this._position.y,this._size.width,this._size.height,y.radius,m.blueNight.key),v.text(this._ctx,this._labelPosition.x,this._labelPosition.y,this._label,y.fontSize,m.white.key)}isPressed(t){return t.x>this._position.x&&t.x<this._position.x+this._size.width&&t.y>this._position.y&&t.y<this._position.y+this._size.height}_setLabelPosition(){const{textWidth:t}=x.calcTextMetrics(this._ctx,this._label,y.fontSize);this._labelPosition.x=this._position.x+this._size.width/2-t/2,this._labelPosition.y=this._position.y+this._size.height/2+y.fontSize/3}static height=74;static fontSize=32;static radius=37}class f{constructor({ctx:t,state:i,assets:e}){this._ctx=t,this._state=i,this._assets=e,this._icon=this._assets.get("star-yellow.png"),this._rating=this._state.getRating(),this._ratingPosition={x:0,y:0},this._setRatingPosition()}render(){v.image(this._ctx,f.iconPositionX,f.iconPositionY,f.iconWidth,f.iconHeight,this._icon),v.text(this._ctx,this._ratingPosition.x,this._ratingPosition.y,this._rating,f.ratingFontSize,m.white.key)}_setRatingPosition(){const{textWidth:t}=x.calcTextMetrics(this._ctx,this._rating,f.ratingFontSize);this._ratingPosition.x=f.iconPositionX-f.ratingMarginRight-t,this._ratingPosition.y=f.ratingPositionY+f.ratingFontSize}static iconPositionX=651;static iconPositionY=23;static iconWidth=30;static iconHeight=29;static ratingPositionY=19;static ratingMarginRight=15;static ratingFontSize=32}class b{constructor({ctx:t,assets:i,position:e,size:s,unlockRating:n,label:o}){this._ctx=t,this._assets=i,this._position=e,this._size=s,this._label=o,this._labelPosition={x:0,y:0},this._setLabelPosition(),this._icon=this._assets.get("star-yellow.png"),this._iconPosition={x:0,y:0},this._setIconPosition(),this._unlockRatingLabel=n,this._unlockRatingLabelPosition={x:0,y:0},this._setUnlockRatingLabelPosition()}render(){v.roundedRect(this._ctx,this._position.x,this._position.y,this._size.width,this._size.height,b.radius,m.blueNight.key,b.opacity),v.text(this._ctx,this._labelPosition.x,this._labelPosition.y,this._label,b.fontSize,m.white.key,b.opacity),v.image(this._ctx,this._iconPosition.x,this._iconPosition.y,b.iconWidth,b.iconHeight,this._icon,b.opacity),v.text(this._ctx,this._unlockRatingLabelPosition.x,this._unlockRatingLabelPosition.y,this._unlockRatingLabel,b.fontSize,m.white.key,b.opacity)}isPressed(){}_setLabelPosition(){this._labelPosition.x=this._position.x+b.paddingHorizontal,this._labelPosition.y=this._position.y+this._size.height/2+b.fontSize/3}_setIconPosition(){const{textWidth:t}=x.calcTextMetrics(this._ctx,this._label,b.fontSize);this._iconPosition.x=this._labelPosition.x+t+b.iconHorizontalMargin,this._iconPosition.y=this._position.y+this._size.height/2-b.iconHeight/2}_setUnlockRatingLabelPosition(){this._unlockRatingLabelPosition.x=this._iconPosition.x+b.iconWidth+b.iconHorizontalMargin,this._unlockRatingLabelPosition.y=this._position.y+this._size.height/2+b.fontSize/3}static height=74;static paddingHorizontal=40;static fontSize=32;static radius=37;static opacity=.25;static iconWidth=30;static iconHeight=29;static iconHorizontalMargin=15}class P{constructor({canvas:t,ctx:i,assets:e,state:s,sceneManager:n}){this._canvas=t,this._ctx=i,this._assets=e,this._state=s,this._sceneManager=n,this._ratingPreview=new f({ctx:this._ctx,state:this._state,assets:this._assets}),this._titleMarkup=[],this._setTitleMarkup(),this._beginnerButton=null,this._mediumButton=null,this._hardButton=null,this._aboutButton=null,this._initButtons()}update(t){}render(){v.rect(this._ctx,0,0,this._canvas.width,this._canvas.height,m.blueDeep.key),this._ratingPreview.render(),this._titleMarkup.forEach((({string:t,position:i})=>{v.text(this._ctx,i.x,i.y,t,P.titleFontSize,m.white.key)})),this._beginnerButton.render(),this._mediumButton.render(),this._hardButton.render(),this._aboutButton.render()}handleClick({position:t}){this._beginnerButton.isPressed(t)?this._sceneManager.showLevelsScene("beginner"):this._mediumButton.isPressed(t)?this._sceneManager.showLevelsScene("medium"):this._hardButton.isPressed(t)?this._sceneManager.showLevelsScene("hard"):this._aboutButton.isPressed(t)&&this._sceneManager.showAboutScene()}handleStartDragging(){}handleDragging(){}handleEndDragging(){}_setTitleMarkup(){const t=[P.title.split("<br>")],i=x.calcMultistringTextMetrics(this._ctx,t,P.titleFontSize,P.titleLineHeight);this._titleMarkup=i.map((t=>{const{string:i,positionY:e,width:s}=t;return{string:i,position:{x:this._canvas.width/2-s/2,y:P.titlePositionY+e}}}))}_initButtons(){this._beginnerButton=new y({ctx:this._ctx,position:{x:P.beginnerButtonPositionX,y:P.beginnerButtonPositionY},size:{width:P.beginnerButtonWidth,height:y.height},label:P.beginnerButtonLabel});const t=this._state.getRating(),i=t>=P.mediumUnlockRating,e=i?y:b;this._mediumButton=new e({ctx:this._ctx,assets:this._assets,position:{x:i?P.mediumButtonPositionX:P.mediumLockedButtonPositionX,y:P.mediumButtonPositionY},size:{width:i?P.mediumButtonWidth:P.mediumLockedButtonWidth,height:e.height},unlockRating:P.mediumUnlockRating,label:P.mediumButtonLabel});const s=t>=P.hardUnlockRating,n=s?y:b;this._hardButton=new n({ctx:this._ctx,assets:this._assets,position:{x:s?P.hardButtonPositionX:P.hardLockedButtonPositionX,y:P.hardButtonPositionY},size:{width:s?P.hardButtonWidth:P.hardLockedButtonWidth,height:n.height},unlockRating:P.hardUnlockRating,label:P.hardButtonLabel}),this._aboutButton=new y({ctx:this._ctx,position:{x:P.aboutButtonPositionX,y:P.aboutButtonPositionY},size:{width:P.aboutButtonWidth,height:y.height},label:P.aboutButtonLabel})}static title="Rows<br>and<br>Columns";static titleFontSize=96;static titleLineHeight=100;static titlePositionY=240;static beginnerButtonLabel="Начинающий";static beginnerButtonWidth=300;static beginnerButtonPositionX=200;static beginnerButtonPositionY=620;static mediumUnlockRating=24;static mediumButtonLabel="Средний";static mediumButtonWidth=222;static mediumLockedButtonWidth=321;static mediumButtonPositionX=239;static mediumButtonPositionY=724;static mediumLockedButtonPositionX=190;static hardUnlockRating=52;static hardButtonLabel="Сложный";static hardButtonWidth=237;static hardLockedButtonWidth=336;static hardButtonPositionX=232;static hardButtonPositionY=828;static hardLockedButtonPositionX=182;static aboutButtonLabel="Об игре";static aboutButtonWidth=210;static aboutButtonPositionX=245;static aboutButtonPositionY=932}class M{constructor({canvas:t,ctx:i,sceneManager:e}){this._canvas=t,this._ctx=i,this._sceneManager=e,this._backButton=null,this._initButton(),this._titlePosition={x:0,y:0},this._setTitlePosition(),this._descriptionMarkup=[],this._setDescriptionMarkup()}update(t){}render(){v.rect(this._ctx,0,0,this._canvas.width,this._canvas.height,m.blueDeep.key),this._backButton.render(),v.text(this._ctx,this._titlePosition.x,this._titlePosition.y,M.title,M.titleFontSize,m.white.key),this._descriptionMarkup.forEach((({string:t,position:i})=>{v.text(this._ctx,i.x,i.y,t,M.descriptionFontSize,m.white.key)}))}_setTitlePosition(){const{textWidth:t}=x.calcTextMetrics(this._ctx,M.title,M.titleFontSize);this._titlePosition.x=this._canvas.width/2-t/2,this._titlePosition.y=M.titlePositionY+M.titleFontSize}_setDescriptionMarkup(){const t=M.description.map((t=>t.split("<br>"))),i=x.calcMultistringTextMetrics(this._ctx,t,M.descriptionFontSize,M.descriptionLineHeight);this._descriptionMarkup=i.map((t=>{const{string:i,positionY:e,width:s}=t;return{string:i,position:{x:this._canvas.width/2-s/2,y:M.descriptionPositionY+e}}}))}handleClick({position:t}){this._backButton.isPressed(t)&&this._sceneManager.showOpenScene()}handleStartDragging(){}handleDragging(){}handleEndDragging(){}_initButton(){this._backButton=new y({ctx:this._ctx,position:{x:M.backButtonPositionX,y:M.backButtonPositionY},size:{width:M.backButtonWidth,height:y.height},label:M.backButtonLabel})}static title="Об игре";static titleFontSize=72;static titlePositionY=294;static description=["Цель игры – собирать<br>композиции из цветных плиток.<br>Перемещайте ряды влево и<br>вправо, а колонки вниз и вверх.<br>Если какая-то плитка при<br>смещении выйдет за границу<br>игрового поля, она появится<br>с противоположного края.<br>Приятной игры.","Связь с автором:<br>mb.games@yandex.ru"];static descriptionFontSize=32;static descriptionLineHeight=42;static descriptionPositionY=450;static backButtonLabel="Назад";static backButtonPositionX=19;static backButtonPositionY=19;static backButtonWidth=181}class w{constructor({ctx:t,color:i,size:e,position:s}){this._ctx=t,this._color=i,this._size=e,this._position=s,this._opacity=1,this._scaleFactor=1}render(){const t=this._size.width*this._scaleFactor,i=this._size.height*this._scaleFactor,e=this._position.x-(t-this._size.width)/2,s=this._position.y-(i-this._size.height)/2,n=w.radius*this._scaleFactor;v.roundedRect(this._ctx,e,s,t,i,n,this._color.key,this._opacity)}getScaleFactor(){return this._scaleFactor}setScaleFactor(t){this._scaleFactor=t}getPosition(){return this._position}setPosition(t){this._position=t}getColor(){return this._color}getOpacity(){return this._opacity}setOpacity(t){this._opacity=t}static radius=30;static colors=[m.blueNight,m.blue,m.green,m.sea,m.red,m.purple,m.orange,m.yellow]}class B{constructor({targetMap:t,initialMap:i,targetMoves:e}){this._targetMap=t,this._initialMap=i,this._targetMoves=e}isMatch(t){return t.every(((t,i)=>t.every(((t,e)=>t.getTile().getColor().id===this._targetMap[i][e]))))}getMapLengths(){return{x:this._targetMap[0].length,y:this._targetMap.length}}getLevelResult(t){return t<=this._targetMoves?B.maxResult:t<=2*this._targetMoves?B.maxResult-1:B.minResult}getLevelColors(){return this._initialMap.flat().map((t=>w.colors.find((i=>i.id===t))))}static maxResult=3;static minResult=1}class k{constructor({ctx:t,assets:i,position:e,levelIndex:s,prevResult:n}){this._ctx=t,this._assets=i,this._position=e,this._levelIndex=s,this._levelLabel=this._levelIndex+1,this._levelLabelPosition={x:0,y:0},this._setLevelLabelPosition(),this._prevResult=n,this._prevResultMarkup=[],this._setPrevResultMarkup(),this._color=this._prevResult?m.green:m.blueNight}render(){v.roundedRect(this._ctx,this._position.x,this._position.y,k.width,k.height,k.radius,this._color.key),v.text(this._ctx,this._levelLabelPosition.x,this._levelLabelPosition.y,this._levelLabel,k.fontSize,m.white.key),this._prevResultMarkup.forEach((({icon:t,position:i})=>{v.image(this._ctx,i.x,i.y,k.iconWidth,k.iconHeight,t)}))}isPressed(t){return t.x>this._position.x&&t.x<this._position.x+k.width&&t.y>this._position.y&&t.y<this._position.y+k.height}_setPrevResultMarkup(){if(!this._prevResult)return;const t=[];for(let i=0;i<B.maxResult;i++)t.push({icon:i<this._prevResult?this._assets.get("star-yellow.png"):this._assets.get("star-green.png"),position:{x:this._position.x+k.padding+i*(k.iconWidth+k.iconGap),y:this._position.y+k.height-k.padding-k.iconHeight}});this._prevResultMarkup=t}_setLevelLabelPosition(){this._levelLabelPosition.x=this._position.x+k.padding,this._levelLabelPosition.y=this._position.y+k.padding+k.fontSize-k.lineHeight/4}getLevelIndex(){return this._levelIndex}static width=158;static height=158;static radius=46;static padding=24;static fontSize=48;static lineHeight=52;static iconWidth=30;static iconHeight=29;static iconGap=10}const C=JSON.parse('{"beginner":[{"id":1,"targetMap":[[3,3,3,3],[3,10,10,3],[3,10,10,3],[3,3,3,3]],"initialMap":[[3,3,10,3],[10,3,10,3],[3,10,3,3],[3,3,3,3]],"moves":5},{"id":2,"targetMap":[[5,3,3,5],[3,5,5,3],[3,5,5,3],[5,3,3,5]],"initialMap":[[5,3,3,5],[5,3,5,3],[3,5,5,5],[3,3,3,5]],"moves":5},{"id":3,"targetMap":[[3,4,4,3],[4,4,4,6],[4,6,6,6],[3,6,6,3]],"initialMap":[[3,4,3,3],[6,4,6,6],[6,6,4,6],[4,4,4,3]],"moves":10},{"id":4,"targetMap":[[3,7,3,7,3],[7,9,9,9,7],[7,9,10,9,7],[3,7,9,7,3],[3,3,7,3,3]],"initialMap":[[9,10,3,9,7],[3,9,9,3,7],[9,7,9,7,7],[7,7,7,7,3],[3,3,3,3,3]],"moves":16},{"id":5,"targetMap":[[3,3,5,3],[3,9,5,5],[9,9,10,3],[9,9,3,3]],"initialMap":[[5,5,5,9],[9,3,9,9],[9,10,3,3],[3,3,3,3]],"moves":16},{"id":6,"targetMap":[[7,7,7,3],[7,10,7,3],[7,7,7,5],[3,5,5,3]],"initialMap":[[10,5,3,5],[7,3,3,3],[5,7,7,7],[7,7,7,7]],"moves":16},{"id":7,"targetMap":[[3,5,9,3],[5,9,9,10],[9,9,9,10],[3,9,10,3]],"initialMap":[[5,9,9,5],[9,3,3,9],[9,9,3,10],[9,10,10,3]],"moves":16},{"id":8,"targetMap":[[4,3,4,3,4],[3,4,6,4,3],[4,6,6,6,4],[3,4,6,4,3],[4,3,4,3,4]],"initialMap":[[4,3,3,4,4],[4,3,6,3,3],[4,3,6,3,6],[4,4,3,4,6],[4,6,4,4,4]],"moves":16},{"id":9,"targetMap":[[3,7,4,3],[7,7,4,4],[10,10,5,5],[3,10,5,3]],"initialMap":[[4,10,4,7],[4,3,10,3],[10,3,7,5],[5,5,3,7]],"moves":20},{"id":10,"targetMap":[[10,10,10,5],[4,3,3,5],[4,3,3,5],[4,7,7,7]],"initialMap":[[5,3,5,3],[7,4,3,3],[10,4,5,4],[10,10,7,7]],"moves":20},{"id":11,"targetMap":[[10,10,10,7],[5,10,7,7],[5,5,4,7],[5,4,4,4]],"initialMap":[[5,7,7,7],[5,10,10,7],[4,10,4,10],[5,4,5,4]],"moves":20},{"id":12,"targetMap":[[10,10,10,7,7],[10,10,10,7,7],[5,5,3,7,7],[5,5,4,4,4],[5,5,4,4,4]],"initialMap":[[3,4,7,5,4],[4,10,5,7,5],[10,5,7,4,10],[7,4,7,7,5],[4,5,10,10,10]],"moves":24}],"medium":[{"id":13,"targetMap":[[3,3,5,5,3,3],[3,3,8,5,5,3],[3,8,8,5,8,3],[3,8,8,8,8,3],[3,3,8,8,3,3],[3,3,3,8,3,3]],"initialMap":[[8,8,5,5,8,5],[8,5,5,3,8,8],[3,3,8,8,8,3],[3,8,3,3,3,8],[3,3,3,3,3,3],[3,3,3,3,3,3]],"moves":24},{"id":14,"targetMap":[[3,4,3,4,3,4],[4,6,4,6,4,6],[6,3,6,3,6,3],[3,4,3,4,3,4],[4,6,4,6,4,6],[6,3,6,3,6,3]],"initialMap":[[4,6,4,4,4,6],[4,3,4,4,3,4],[3,3,3,4,4,3],[3,6,3,4,6,3],[4,6,3,6,6,6],[6,6,6,6,3,3]],"moves":30},{"id":15,"targetMap":[[6,6,6,6,6,3],[6,4,4,4,4,4],[6,4,3,3,6,4],[6,4,3,3,6,4],[6,6,6,6,6,4],[3,4,4,4,4,4]],"initialMap":[[3,6,6,3,6,3],[3,4,3,6,3,6],[6,6,4,4,4,4],[4,6,4,4,4,4],[4,6,6,6,6,4],[4,4,6,4,6,6]],"moves":30},{"id":16,"targetMap":[[3,3,4,4,4,3,3],[3,4,4,4,4,4,3],[4,6,6,6,6,4,6],[6,6,6,3,6,6,6],[6,4,6,3,3,3,3],[6,4,4,6,4,3,3],[4,6,4,4,6,6,6]],"initialMap":[[4,4,3,4,6,4,6],[6,4,4,4,4,3,3],[4,6,6,3,4,4,4],[3,6,6,4,4,3,3],[4,6,4,3,3,3,3],[4,6,6,6,6,3,6],[6,3,6,6,6,6,6]],"moves":30},{"id":17,"targetMap":[[4,4,4,7,9,10],[4,4,4,7,9,9],[6,4,4,4,7,7],[6,6,4,4,4,4],[6,6,6,4,4,6],[4,4,4,4,6,6]],"initialMap":[[6,4,7,10,7,6],[6,6,9,4,6,6],[4,7,4,7,9,9],[4,4,4,6,6,4],[6,4,4,4,4,4],[4,4,4,4,4,4]],"moves":24},{"id":18,"targetMap":[[6,4,4,4,4,4],[6,4,6,6,6,6],[6,4,6,4,4,6],[6,4,6,6,4,6],[6,4,4,4,4,6],[6,6,6,6,6,6]],"initialMap":[[4,4,6,6,4,6],[6,4,4,4,4,6],[4,4,4,6,6,4],[6,6,4,4,4,6],[4,6,6,6,6,6],[6,6,6,6,6,6]],"moves":30},{"id":19,"targetMap":[[10,10,10,10,10,7],[5,10,10,10,7,7],[5,5,10,7,7,7],[5,5,5,4,7,7],[5,5,4,4,4,7],[5,4,4,4,4,4]],"initialMap":[[7,10,5,5,7,5],[7,7,4,5,5,7],[5,10,10,7,5,4],[5,10,5,7,10,7],[7,10,10,4,10,4],[10,4,4,4,4,4]],"moves":30},{"id":20,"targetMap":[[9,10,9,3,9,9,9],[10,3,9,3,9,3,10],[9,9,9,10,9,10,10],[3,3,10,3,9,3,3],[9,9,9,9,9,10,9],[9,3,10,3,10,3,9],[9,10,10,3,9,9,9]],"initialMap":[[9,3,10,9,10,10,10],[10,10,9,9,9,10,10],[10,10,10,3,10,9,3],[3,3,9,3,9,9,3],[9,9,3,3,9,9,9],[9,3,9,3,9,9,3],[9,3,9,9,9,9,9]],"moves":36},{"id":21,"targetMap":[[3,3,3,5,3,3,3],[3,3,5,5,10,3,3],[3,10,5,5,10,10,3],[3,10,5,10,10,10,3],[3,10,10,10,10,10,3],[3,3,10,10,10,3,3],[3,3,3,10,3,3,3]],"initialMap":[[5,5,5,10,10,5,5],[10,10,3,5,3,10,10],[3,3,3,10,3,10,3],[10,10,10,3,3,3,3],[10,10,3,3,3,10,3],[3,10,10,10,3,3,3],[3,3,3,3,3,3,3]],"moves":30},{"id":22,"targetMap":[[3,7,7,3,7,7,3],[7,9,9,9,9,9,7],[7,9,10,10,10,9,7],[7,9,10,10,10,9,7],[3,7,9,10,9,7,3],[3,3,7,9,7,3,3],[3,3,3,7,3,3,3]],"initialMap":[[10,3,9,3,9,3,10],[9,9,3,9,7,7,7],[7,9,9,7,7,9,9],[9,7,7,7,7,7,9],[3,3,9,7,3,3,7],[7,10,10,3,7,10,10],[10,3,3,3,3,3,3]],"moves":36},{"id":23,"targetMap":[[3,3,3,9,3,3,3],[3,3,10,9,9,3,3],[3,5,7,5,9,9,3],[3,10,10,10,7,9,9],[5,10,5,10,10,10,3],[10,7,10,3,3,3,3],[10,3,3,3,3,3,3]],"initialMap":[[9,3,7,5,7,3,7],[9,9,9,10,3,9,10],[3,10,9,3,10,3,5],[9,10,10,3,5,10,10],[10,5,10,10,3,3,3],[3,3,3,3,3,3,3],[3,3,3,3,3,3,3]],"moves":30},{"id":24,"targetMap":[[10,10,10,10,10,10,5],[10,3,3,3,3,5,5],[5,3,3,3,5,5,5],[5,5,3,5,5,5,10],[5,5,5,5,5,3,10],[10,5,5,5,3,3,10],[10,10,5,10,10,10,10]],"initialMap":[[5,5,10,10,5,5,5],[3,5,10,5,5,5,10],[5,3,10,5,3,5,5],[10,5,5,5,5,5,10],[5,10,5,5,3,3,3],[10,3,10,10,10,10,10],[10,3,3,3,3,10,10]],"moves":36}],"hard":[{"id":25,"targetMap":[[3,3,3,7,3,3,10],[10,3,7,7,3,3,3],[3,3,7,9,7,3,3],[3,7,9,10,9,7,3],[7,9,10,10,9,7,3],[7,7,10,10,10,9,3],[7,9,10,10,10,9,7]],"initialMap":[[3,3,7,7,10,10,3],[9,7,3,10,9,7,9],[9,7,7,7,3,10,3],[9,10,3,3,10,9,10],[3,3,3,7,3,3,3],[3,7,10,3,7,9,10],[7,9,10,7,10,7,3]],"moves":40},{"id":26,"targetMap":[[3,3,10,10,10,3,3],[3,10,3,10,3,10,3],[10,10,3,10,3,10,10],[10,10,10,10,10,10,10],[10,10,10,3,10,10,10],[3,10,10,3,10,10,3],[3,3,10,10,10,3,3]],"initialMap":[[10,3,10,3,10,10,10],[3,10,10,10,10,10,10],[10,3,3,3,10,3,10],[10,10,10,10,10,3,3],[3,3,10,10,10,10,10],[10,10,3,3,10,10,3],[3,3,3,10,10,10,3]],"moves":30},{"id":27,"targetMap":[[3,3,3,3,3,3,3],[3,6,6,4,6,4,3],[6,6,4,6,4,6,4],[3,6,6,4,6,4,3],[3,3,6,6,4,3,3],[3,3,3,6,3,3,3],[3,3,3,3,3,3,3]],"initialMap":[[3,3,3,3,6,3,3],[4,6,6,3,3,6,4],[4,3,6,3,6,4,3],[3,6,3,4,3,3,3],[3,3,3,3,6,6,3],[4,6,3,6,6,3,6],[3,3,4,3,4,3,3]],"moves":24},{"id":28,"targetMap":[[3,7,7,10,10,3],[3,7,7,10,10,3],[3,7,9,9,10,3],[3,10,9,9,7,3],[3,10,10,7,7,3],[3,3,10,7,3,3]],"initialMap":[[7,10,10,3,10,7],[10,7,3,3,9,10],[3,7,3,9,3,7],[3,3,10,7,9,10],[10,7,9,3,3,3],[3,10,7,3,3,7]],"moves":36},{"id":29,"targetMap":[[5,5,5,5,4,5,5],[5,5,5,5,4,4,5],[5,4,9,4,4,4,9],[9,5,5,5,10,10,5],[5,5,5,5,5,10,10],[5,5,5,5,10,10,10],[5,10,10,10,10,10,5]],"initialMap":[[5,5,5,5,5,5,5],[5,4,5,5,10,10,5],[5,5,5,4,5,9,5],[10,10,10,4,9,10,5],[5,5,5,10,5,5,10],[10,10,5,4,5,10,4],[4,9,4,10,5,5,5]],"moves":30},{"id":30,"targetMap":[[4,4,6,6,9,9,10],[4,6,6,9,9,10,10],[4,6,9,9,10,10,9],[6,6,9,9,10,10,5],[9,9,9,10,10,9,5],[9,10,10,10,10,5,5],[10,9,10,5,5,5,5]],"initialMap":[[10,5,9,6,6,10,9],[5,4,9,9,9,10,9],[5,9,10,10,10,6,5],[5,10,4,5,9,5,10],[6,10,10,10,4,6,9],[10,6,9,10,5,10,9],[6,9,9,10,9,4,9]],"moves":36},{"id":31,"targetMap":[[3,5,5,3,3,3,3],[5,9,3,3,5,5,3],[5,3,9,3,3,9,5],[3,3,9,3,9,3,5],[4,5,10,10,10,5,4],[5,10,10,10,10,10,5],[4,4,4,4,4,4,4]],"initialMap":[[5,9,5,3,9,3,5],[4,10,9,3,10,3,5],[3,4,5,9,5,10,3],[4,4,3,3,10,4,10],[5,10,4,4,3,3,4],[10,3,3,3,5,5,5],[10,9,5,4,3,3,5]],"moves":30},{"id":32,"targetMap":[[5,5,5,5,5,7],[10,10,10,10,5,7],[10,4,3,3,5,7],[10,4,3,3,5,7],[10,4,7,7,7,7],[10,4,4,4,4,4]],"initialMap":[[3,7,10,7,7,5],[4,7,5,4,7,5],[5,7,4,5,10,5],[4,4,3,4,3,7],[4,10,7,10,5,3],[10,5,10,10,10,4]],"moves":40},{"id":33,"targetMap":[[10,5,5,5,5,5,5],[10,5,10,10,10,10,5],[10,5,10,5,5,10,5],[10,5,10,10,5,10,5],[10,5,5,5,5,10,5],[10,10,10,10,10,10,5],[5,5,5,5,5,5,5]],"initialMap":[[10,5,10,10,5,5,5],[5,10,5,10,10,5,10],[10,5,5,10,10,10,10],[5,5,10,5,10,5,10],[5,5,5,5,5,10,5],[5,5,10,5,10,5,5],[5,10,5,10,10,5,5]],"moves":40},{"id":34,"targetMap":[[7,7,7,7,7,3,3],[7,9,9,9,9,9,3],[7,9,10,10,10,10,10],[7,9,10,3,7,9,10],[7,7,7,7,7,9,10],[3,9,9,9,9,9,10],[3,3,10,10,10,10,10]],"initialMap":[[9,7,7,3,9,10,9],[7,9,7,3,10,10,7],[10,10,9,7,3,10,9],[3,10,9,7,10,7,10],[9,10,9,3,7,10,7],[9,3,9,10,10,7,9],[7,7,7,9,3,10,9]],"moves":50},{"id":35,"targetMap":[[3,3,3,3,7,7,7],[8,8,8,3,7,10,7],[8,10,9,9,9,7,7],[8,8,9,10,9,5,3],[5,7,7,7,9,3,3],[3,7,10,7,5,3,3],[3,7,7,7,3,3,3]],"initialMap":[[9,3,7,3,3,8,3],[3,3,7,5,5,8,3],[3,7,3,7,7,7,7],[3,10,5,10,10,3,7],[3,3,7,7,8,7,9],[8,7,9,7,3,8,9],[9,9,3,8,7,7,10]],"moves":40},{"id":36,"targetMap":[[3,7,9,9,7,3],[7,9,10,10,9,7],[9,10,5,5,10,9],[10,5,6,6,5,10],[5,6,4,4,6,5],[6,4,8,8,4,6]],"initialMap":[[5,9,4,4,6,7],[10,3,7,7,6,10],[9,5,9,4,10,10],[7,5,9,6,5,4],[6,3,9,8,10,9],[6,8,10,5,6,5]],"moves":50}]}');class S{constructor({canvas:t,ctx:i,assets:e,state:s,sceneManager:n,levelsKey:o}){this._canvas=t,this._ctx=i,this._assets=e,this._state=s,this._sceneManager=n,this._levelsKey=o,this._backButton=null,this._initButton(),this._titleMarkup=[],this._setTitleMarkup(),this._levelsButtons=[],this._setLevelsButtons()}update(t){}render(){v.rect(this._ctx,0,0,this._canvas.width,this._canvas.height,m.blueDeep.key),this._backButton.render(),this._titleMarkup.forEach((({string:t,position:i})=>{v.text(this._ctx,i.x,i.y,t,S.titleFontSize,m.white.key)})),this._levelsButtons.forEach((t=>{t.render()}))}handleClick({position:t}){this._backButton.isPressed(t)&&this._sceneManager.showOpenScene(),this._levelsButtons.forEach((i=>{if(i.isPressed(t)){const t=i.getLevelIndex();this._sceneManager.showCoreScene(this._levelsKey,t)}}))}handleStartDragging(){}handleDragging(){}handleEndDragging(){}_setTitleMarkup(){const t=[S.title.split("<br>")],i=x.calcMultistringTextMetrics(this._ctx,t,S.titleFontSize,S.titleLineHeight);this._titleMarkup=i.map((t=>{const{string:i,positionY:e,width:s}=t;return{string:i,position:{x:this._canvas.width/2-s/2,y:S.titlePositionY+e}}}))}_setLevelsButtons(){const t=C[this._levelsKey];for(let i=0;i<t.length;i++){const e=i%3,s=Math.floor(i/3),n=new k({ctx:this._ctx,assets:this._assets,position:{x:S.gridPositionX+e*(k.width+S.gridGap),y:S.gridPositionY+s*(k.height+S.gridGap)},levelIndex:i,prevResult:this._state.getLevelResult(t[i].id)||0});this._levelsButtons.push(n)}}_initButton(){this._backButton=new y({ctx:this._ctx,position:{x:S.backButtonPositionX,y:S.backButtonPositionY},size:{width:S.backButtonWidth,height:y.height},label:S.backButtonLabel})}static title="Выберите<br>уровень";static titlePositionY=162;static titleFontSize=72;static titleLineHeight=76;static gridWidth=574;static gridGap=50;static gridPositionX=63;static gridPositionY=394;static backButtonLabel="Назад";static backButtonPositionY=19;static backButtonPositionX=19;static backButtonWidth=181}class L{constructor({ctx:t,map:i}){this._ctx=t,this._map=i,this._columnWidth=0,this._rowHeight=0,this._setMetrics()}render(){this._map.forEach(((t,i)=>{t.forEach(((t,e)=>{const s=L.positionX+(this._columnWidth+L.gap)*e,n=L.positionY+(this._rowHeight+L.gap)*i,o=w.colors.find((i=>i.id===t));v.roundedRect(this._ctx,s,n,this._columnWidth,this._rowHeight,L.tileRadius,o.key)}))}))}_setMetrics(){const t=this._map[0].length,i=this._map.length;this._columnWidth=(L.width-L.gap*(t-1))/t,this._rowHeight=(L.height-L.gap*(i-1))/i}static width=194;static height=194;static positionX=487;static positionY=19;static gap=2;static tileRadius=10}class R{constructor({coords:t}){this._coords=t,this._tile=null,this._detachedTile=null}render(){this._tile&&this._tile.render()}setTile(t){this._tile=t;const i=this._detachedTile;return this._detachedTile=null,this._tile!==i}getTile(){return this._tile}detachTile(){const t=this._tile;return this._detachedTile=t,this._tile=null,t}getCoords(){return this._coords}}class D{constructor({tile:t,delay:i=0}){this._tile=t,this._delay=i,this._startTime=null,this._finished=!1}update({timestamp:t}){if(this._finished)return;null===this._startTime&&(this._startTime=t+this._delay);const i=t-this._startTime;if(i<0)return;let e=1;if(i<D.duration){const t=i/D.duration;e=Math.pow(1-t,2)*D.path[0]+2*(1-t)*t*D.path[1]+Math.pow(t,2)*D.path[2]}else this._finished=!0;this._tile.setScaleFactor(e)}isFinished(){return this._finished}static duration=1e3;static path=[1,.6,1]}class T{constructor({ctx:t,assets:i,state:e,sceneManager:s,levelsKey:n,levelIndex:o,levelId:a,levelController:r}){this._ctx=t,this._assets=i,this._state=e,this._sceneManager=s,this._levelsKey=n,this._levelIndex=o,this._levelId=a,this._levelController=r,this._columnWidth=0,this._rowHeight=0,this._maxOutOfBoundsX=0,this._maxOutOfBoundsY=0,this._setMetrics(),this._map=[],this._setMap(),this._setTiles(),this._animations=[],this._startDraggingPosition=null,this._startDraggingCoords=null,this._prevDraggingPosition=null,this._draggingAxis=null,this._detachedTiles=[],this._levelComplete=!1,this._movesCounter=0}update(t){this._animations.forEach((i=>i.update(t))),this._animations=this._animations.filter((t=>!t.isFinished()))}render(){this._map.forEach((t=>{t.forEach((t=>t.render()))})),this._detachedTiles.forEach((t=>t.render()))}handleStartDragging({position:t}){!this._levelComplete&&this._isFieldIncludesPosition(t)&&(this._startDraggingPosition=t,this._startDraggingCoords=this.getCoordsByPosition(t),this._prevDraggingPosition=t)}handleDragging({position:t}){this._startDraggingPosition&&this._startDraggingCoords&&(this._draggingAxis||this._setDraggingAxis(t),this._detachedTiles.length||this._detachTiles(),"x"===this._draggingAxis?this._moveRow(t):this._moveColumn(t),this._prevDraggingPosition=t)}_setDraggingAxis(t){const i=this._startDraggingPosition.x-t.x,e=this._startDraggingPosition.y-t.y;this._draggingAxis=Math.abs(i)>Math.abs(e)?"x":"y"}handleEndDragging(t){if(!this._detachedTiles.length)return;const i=this._draggingAxis;this._detachedTiles.sort(((t,e)=>t.getPosition()[i]-e.getPosition()[i]));let e=!1;"x"===i?this._map[this._startDraggingCoords.y].forEach((t=>{const i=this._attachFirstDetachedTileToCell(t);e=e||i})):this._map.forEach((t=>{const i=t[this._startDraggingCoords.x],s=this._attachFirstDetachedTileToCell(i);e=e||s})),e&&(this._movesCounter+=1),this._startDraggingPosition=null,this._startDraggingCoords=null,this._prevDraggingPosition=null,this._draggingAxis=null,this._handleDraggingResult()}_attachFirstDetachedTileToCell(t){const i=t.getCoords(),e=this._detachedTiles.shift(),s=this.getPositionByCoords(i);return e.setPosition(s),e.setOpacity(1),t.setTile(e)}async _handleDraggingResult(){if(this._levelComplete=this._levelController.isMatch(this._map),!this._levelComplete)return;this._startLevelCompliteAnimation();const t=this._levelController.getLevelResult(this._movesCounter);await this._state.setLevelResult(this._levelId,t),setTimeout((()=>{this._sceneManager.showResultScene(this._movesCounter,t,this._levelsKey,this._levelIndex)}),1500)}_startLevelCompliteAnimation(){this._map.forEach((t=>{t.forEach((t=>{const i=t.getTile(),e=new D({tile:i});this._animations.push(e)}))}))}_detachTiles(){this._detachedTiles="x"===this._draggingAxis?this._map[this._startDraggingCoords.y].map((t=>t.detachTile())):this._map.map((t=>t[this._startDraggingCoords.x].detachTile()))}_moveRow(t){const i=t.x-this._prevDraggingPosition.x;this._detachedTiles.forEach((t=>{const e=t.getPosition(),s={x:e.x+i,y:e.y};i<0&&s.x<T.positionX-this._maxOutOfBoundsX?s.x+=this._detachedTiles.length*(this._columnWidth+T.gap):i>0&&s.x+this._columnWidth>T.positionX+T.width+this._maxOutOfBoundsX&&(s.x-=this._detachedTiles.length*(this._columnWidth+T.gap));let n=1;s.x<T.positionX?n=1-(T.positionX-s.x)/this._maxOutOfBoundsX:s.x+this._columnWidth>T.positionX+T.width&&(n=1-(s.x+this._columnWidth-(T.positionX+T.width))/this._maxOutOfBoundsX),t.setOpacity(n),t.setPosition(s)}))}_moveColumn(t){const i=t.y-this._prevDraggingPosition.y;this._detachedTiles.forEach((t=>{const e=t.getPosition(),s={x:e.x,y:e.y+i};i<0&&s.y<T.positionY-this._maxOutOfBoundsY?s.y+=this._detachedTiles.length*(this._rowHeight+T.gap):i>0&&s.y+this._rowHeight>T.positionY+T.height+this._maxOutOfBoundsY&&(s.y-=this._detachedTiles.length*(this._rowHeight+T.gap));let n=1;s.y<T.positionY?n=1-(T.positionY-s.y)/this._maxOutOfBoundsY:s.y+this._rowHeight>T.positionY+T.height&&(n=1-(s.y+this._rowHeight-(T.positionY+T.height))/this._maxOutOfBoundsY),t.setOpacity(n),t.setPosition(s)}))}getCoordsByPosition(t){return{x:Math.floor((t.x-T.positionX)/(T.gap+this._columnWidth)),y:Math.floor((t.y-T.positionY)/(T.gap+this._rowHeight))}}getPositionByCoords(t){return{x:T.positionX+t.x*(T.gap+this._columnWidth),y:T.positionY+t.y*(T.gap+this._rowHeight)}}_getCellByCoords(t){return this._map[t.y][t.x]}_isFieldIncludesPosition(t){return t.x>T.positionX&&t.x<T.positionX+T.width&&t.y>T.positionY&&t.y<T.positionY+T.height}_setMetrics(){const{x:t,y:i}=this._levelController.getMapLengths();this._columnWidth=(T.width-T.gap*(t-1))/t,this._rowHeight=(T.height-T.gap*(i-1))/i,this._maxOutOfBoundsX=(T.gap+this._columnWidth)/2,this._maxOutOfBoundsY=(T.gap+this._rowHeight)/2}_setMap(){const{x:t,y:i}=this._levelController.getMapLengths();for(let e=0;e<i;e++){const i=[];for(let s=0;s<t;s++){const t=new R({coords:{x:s,y:e}});i.push(t)}this._map.push(i)}}_setTiles(){let t=this._levelController.getLevelColors();this._map.forEach((i=>{i.forEach((i=>{const e=i.getCoords(),s=t.shift(),n=this._createTile(e,s);i.setTile(n)}))}))}_createTile(t,i){const e=this.getPositionByCoords(t),s={width:this._columnWidth,height:this._rowHeight};return new w({ctx:this._ctx,color:i,size:s,position:e})}static width=662;static height=662;static positionX=19;static positionY=292;static gap=10}class A{constructor({canvas:t,ctx:i,assets:e,state:s,sceneManager:n,levelsKey:o,levelIndex:a}){this._canvas=t,this._ctx=i,this._assets=e,this._state=s,this._sceneManager=n,this._backButton=null,this._initButton(),this._levelsKey=o,this._levelIndex=a,this._level=C[this._levelsKey][this._levelIndex],this._levelPreview=new L({ctx:this._ctx,map:this._level.targetMap}),this._levelController=new B({targetMap:this._level.targetMap,initialMap:this._level.initialMap,targetMoves:this._level.moves}),this._field=new T({ctx:this._ctx,assets:this._assets,state:this._state,sceneManager:this._sceneManager,levelsKey:this._levelsKey,levelIndex:this._levelIndex,levelId:this._level.id,levelController:this._levelController})}update(t){this._field.update(t)}render(){v.rect(this._ctx,0,0,this._canvas.width,this._canvas.height,m.blueDeep.key),this._backButton.render(),this._levelPreview.render(),this._field.render()}handleClick({position:t}){this._backButton.isPressed(t)&&this._sceneManager.showLevelsScene(this._levelsKey)}handleStartDragging(t){this._field.handleStartDragging(t)}handleDragging(t){this._field.handleDragging(t)}handleEndDragging(t){this._field.handleEndDragging(t)}_initButton(){this._backButton=new y({ctx:this._ctx,position:{x:A.backButtonPositionX,y:A.backButtonPositionY},size:{width:A.backButtonWidth,height:y.height},label:A.backButtonLabel})}static backButtonLabel="Назад";static backButtonWidth=181;static backButtonPositionX=19;static backButtonPositionY=19}class z{constructor({canvas:t,ctx:i,assets:e,state:s,sceneManager:n,movesCounter:o,levelResult:a,levelsKey:r,levelIndex:h}){this._canvas=t,this._ctx=i,this._assets=e,this._state=s,this._sceneManager=n,this._movesCounter=o,this._levelResult=a,this._levelsKey=r,this._levelIndex=h,this._ratingPreview=new f({ctx:this._ctx,state:this._state,assets:this._assets}),this._titleMarkup=[],this._setTitleMarkup(),this._movesCounterHintPosition={x:0,y:0},this._setMovesCounterHintPosition(),this._movesCounterPosition={x:0,y:0},this._setMovesCounterPosition(),this._levelResultMarkup=[],this._setLevelResultMarkup(),this._continueButton=null,this._repeatButton=null,this._initButtons()}update(t){}render(){v.rect(this._ctx,0,0,this._canvas.width,this._canvas.height,m.blueDeep.key),this._ratingPreview.render(),this._titleMarkup.forEach((({string:t,position:i})=>{v.text(this._ctx,i.x,i.y,t,z.titleFontSize,m.white.key)})),v.text(this._ctx,this._movesCounterHintPosition.x,this._movesCounterHintPosition.y,z.movesCounterHintLabel,z.movesCounterHintFontSize,m.yellow.key),v.text(this._ctx,this._movesCounterPosition.x,this._movesCounterPosition.y,this._movesCounter,z.movesCounterFontSize,m.yellow.key),this._levelResultMarkup.forEach((({icon:t,position:i})=>{v.image(this._ctx,i.x,i.y,z.iconWidth,z.iconHeight,t)})),this._continueButton.render(),this._repeatButton.render()}handleClick({position:t}){if(this._continueButton.isPressed(t)){const t=this._levelIndex+1;C[this._levelsKey][t]?this._sceneManager.showCoreScene(this._levelsKey,t):this._sceneManager.showLevelsScene(this._levelsKey)}else this._repeatButton.isPressed(t)&&this._sceneManager.showCoreScene(this._levelsKey,this._levelIndex)}handleStartDragging(){}handleDragging(){}handleEndDragging(){}_setMovesCounterHintPosition(){this._movesCounterHintPosition.x=z.movesCounterHintPositionX,this._movesCounterHintPosition.y=z.movesCounterHintPositionY+z.movesCounterHintFontSize}_setMovesCounterPosition(){const{textWidth:t}=x.calcTextMetrics(this._ctx,this._movesCounter,z.movesCounterFontSize);this._movesCounterPosition.x=this._canvas.width/2-t/2,this._movesCounterPosition.y=z.movesCounterPositionY+z.movesCounterFontSize}_setTitleMarkup(){const t=[z.title.split("<br>")],i=x.calcMultistringTextMetrics(this._ctx,t,z.titleFontSize,z.titleLineHeight);this._titleMarkup=i.map((t=>{const{string:i,positionY:e,width:s}=t;return{string:i,position:{x:this._canvas.width/2-s/2,y:z.titlePositionY+e}}}))}_setLevelResultMarkup(){const t=[];for(let i=0;i<B.maxResult;i++)t.push({icon:i<this._levelResult?this._assets.get("star-yellow.png"):this._assets.get("star-blue.png"),position:{x:z.ratingPositionX+i*(z.iconWidth+z.iconGap),y:z.ratingPositionY}});this._levelResultMarkup=t}_initButtons(){this._continueButton=new y({ctx:this._ctx,position:{x:z.continueButtonPositionX,y:z.continueButtonPositionY},size:{width:z.continueButtonWidth,height:z.buttonsHeight},label:z.continueButtonLabel}),this._repeatButton=new y({ctx:this._ctx,position:{x:z.repeatButtonPositionX,y:z.repeatButtonPositionY},size:{width:z.repeatButtonWidth,height:z.buttonsHeight},label:z.repeatButtonLabel})}static title="Уровень<br>пройден!";static titleFontSize=72;static titleLineHeight=76;static titlePositionY=251;static movesCounterHintLabel="Ходов:";static movesCounterHintFontSize=48;static movesCounterHintPositionX=267;static movesCounterHintPositionY=483;static movesCounterFontSize=96;static movesCounterPositionY=541;static ratingPositionX=221;static ratingPositionY=667;static iconWidth=73;static iconHeight=70;static iconGap=20;static continueButtonLabel="Продолжить";static continueButtonPositionX=206;static continueButtonPositionY=817;static continueButtonWidth=289;static repeatButtonLabel="Повторить уровень";static repeatButtonPositionX=151;static repeatButtonPositionY=921;static repeatButtonWidth=399;static buttonsHeight=74}class Y{constructor({canvas:t,ctx:i,assets:e,state:s}){this._canvas=t,this._ctx=i,this._assets=e,this._state=s,this._currentScene=null,this._futureScene=null,this._transitionOverlayOffsetX=1}update(t){this._currentScene&&this._currentScene.update(t),this._futureScene?this._updateSceneOut(t):this._transitionOverlayOffsetX<=0&&this._updateSceneIn(t)}_updateSceneOut({prevFrameDuration:t}){this._currentScene&&0!==this._transitionOverlayOffsetX?this._transitionOverlayOffsetX=Math.max(this._transitionOverlayOffsetX-t/Y.transitionDuration,0):(this._currentScene=this._futureScene,this._futureScene=null)}_updateSceneIn({prevFrameDuration:t}){this._transitionOverlayOffsetX=Math.max(this._transitionOverlayOffsetX-t/Y.transitionDuration,-1),-1===this._transitionOverlayOffsetX&&(this._transitionOverlayOffsetX=1)}render(){this._currentScene&&this._currentScene.render(),1!==this._transitionOverlayOffsetX&&this._renderTransitionOverlay()}_renderTransitionOverlay(){const t=this._canvas.width*this._transitionOverlayOffsetX;v.rect(this._ctx,t,0,this._canvas.width,this._canvas.height,m.blueDeep.key)}_getScenesCommonProps(){return{canvas:this._canvas,ctx:this._ctx,assets:this._assets,state:this._state,sceneManager:this}}_isInTransition(){return this._futureScene||1!==this._transitionOverlayOffsetX}handleClick(t){this._isInTransition()||this._currentScene&&this._currentScene.handleClick(t)}handleStartDragging(t){this._isInTransition()||this._currentScene&&this._currentScene.handleStartDragging(t)}handleDragging(t){this._isInTransition()||this._currentScene&&this._currentScene.handleDragging(t)}handleEndDragging(t){this._isInTransition()||this._currentScene&&this._currentScene.handleEndDragging(t)}showOpenScene(){this._futureScene=new P(this._getScenesCommonProps())}showAboutScene(){this._futureScene=new M(this._getScenesCommonProps())}showLevelsScene(t){this._futureScene=new S({...this._getScenesCommonProps(),levelsKey:t})}showCoreScene(t,i){this._futureScene=new A({...this._getScenesCommonProps(),levelsKey:t,levelIndex:i})}showResultScene(t,i,e,s){this._futureScene=new z({...this._getScenesCommonProps(),movesCounter:t,levelResult:i,levelsKey:e,levelIndex:s})}static transitionDuration=300}class O{constructor(t){this._canvas=t,this._ctx=t.getContext("2d"),this._setRenderSize(),this._assets=new u,this._state=new p,this._sceneManager=new Y({canvas:this._canvas,ctx:this._ctx,assets:this._assets,state:this._state}),this._prevTimestamp=null,this._draggingStarted=!1,this._addEventHandlers(),this._startGame()}async _startGame(){await document.fonts.load("1px Nunito"),await this._assets.load(),await this._state.loadPlayerStats(),this._sceneManager.showOpenScene(),requestAnimationFrame((t=>{this._gameLoop(t)}))}_gameLoop(t){requestAnimationFrame((t=>{this._gameLoop(t)}));const i=t-(this._prevTimestamp||t),e=i/1e3;this._sceneManager.update({delta:e,prevFrameDuration:i,timestamp:t}),this._prevTimestamp=t,this._render()}_render(){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._sceneManager.render()}_addEventHandlers(){this._canvas.addEventListener("click",(t=>this._handleClick(t))),this._canvas.addEventListener("mousedown",(t=>this._handleStartDragging(t))),window.addEventListener("mousemove",(t=>this._handleDragging(t))),window.addEventListener("mouseup",(t=>this._handleEndDragging(t))),this._canvas.addEventListener("touchstart",(t=>this._handleStartDragging(t))),window.addEventListener("touchmove",(t=>this._handleDragging(t))),window.addEventListener("touchend",(t=>this._handleEndDragging(t))),window.addEventListener("resize",(()=>this._setRenderSize()))}_handleClick(t){const{clientX:i,clientY:e}=t,s=this._transformClickPosition({x:i,y:e});this._sceneManager.handleClick({position:s})}_handleStartDragging(t){this._draggingStarted=!0;const{clientX:i,clientY:e}=t.touches?.[0]||t,s=this._transformClickPosition({x:i,y:e});this._sceneManager.handleStartDragging({position:s})}_handleEndDragging(t){this._draggingStarted=!1;const{clientX:i,clientY:e}=t.touches?.[0]||t,s=this._transformClickPosition({x:i,y:e});this._sceneManager.handleEndDragging({position:s})}_handleDragging(t){if(!this._draggingStarted)return;const{clientX:i,clientY:e}=t.touches?.[0]||t,s=this._transformClickPosition({x:i,y:e});this._sceneManager.handleDragging({position:s})}_transformClickPosition({x:t,y:i}){return t-=this._canvas.getBoundingClientRect().left,t*=this._canvas.width/parseFloat(this._canvas.style.width),i-=this._canvas.getBoundingClientRect().top,{x:t,y:i*=this._canvas.height/parseFloat(this._canvas.style.height)}}_setRenderSize(){const t=document.documentElement.clientWidth,i=document.documentElement.clientHeight;let e=this._canvas.width/this._canvas.height,s=i,n=s*e;n>t&&(e=this._canvas.height/this._canvas.width,n=t,s=n*e),this._canvas.style.width=n+"px",this._canvas.style.height=s+"px"}}addEventListener("DOMContentLoaded",(async()=>{await g.initYSDK(),await g.initPlayer(),new O(document.getElementById("colored-tiles"))}))})()})();
//# sourceMappingURL=index.js.map